Qt跨屏幕截图工具技术架构及关键技术讲解

# 架构

## 快速入门

本程序执行的几个主要工作依次为：

graph TB

    A[应用启动] --> B[枚举窗口，记录窗口位置] --> C[屏幕拍照（涵盖所有屏幕）] --> D[窗口全屏（跨屏）] --> E[窗口绘制屏幕快照]  --> F[鼠标移动，B记录的窗口区域高亮]  --> G[鼠标拖动，绘制截图区域，改变截图区域大小和位置] --> I[显示绘图工具栏]  --> J[鼠标在截图区域绘图]   --> H[显示滑块，改变绘图元素的大小和位置]  --> K[保存到剪切板、文件]   --> L[应用退出]

## 重要概念

- 元素

> 元素记录了用户绘制的内容：
>
> 路径的顶点、是否填充、边框粗细、填充颜色、边框颜色、文字内容、自由路径的path、`参与绘制`（用于undo redo）。

- 图层

> 图层用于支持用户鼠标绘图、元素位置和大小的改变、橡皮擦、马赛克、undo 、 redo等功能

## 元素介绍

- 在用户正式开始绘制内容前，用户会通过绘图工具栏确认元素的各种属性（类型、颜色、大小、粗细等）。

- 当用户按下鼠标左键后，程序将创建一个绘图元素对象，并保存到历史记录容器中（为以后的undo redo做准备）。

- 如果用户没有拖动鼠标绘制元素，在按下鼠标左键之后，马上释放了鼠标左键，则此元素将从历史记录中移除。

- 如果用户拖动鼠标绘制元素，则程序会实时改变绘图元素对象的相关属性（主要是元素各个顶点的位置信息）

## 图层介绍

绘图开始前，程序提前预制了三个图层，从上到下依次是：

- 绘图层

> 用于绘制动态图像，比如用户拖动创造矩形、椭圆、箭头，或拖动改变矩形、椭圆、箭头大小或位置等。这类需要实时变化的图像，都是在绘图层绘制的。`改变绘图层元素前，会清空绘图层的所有内容`

- 背景层

> 用于绘制桌面快照，程序运行之初会为用户的整个桌面拍了一张照片。这张照片一般情况下是不会变化的，它被绘制在背景层。

- 马赛克层

> 这一层专为绘制马赛克服务，一般情况下不会参与到应用程序的渲染工作中（更详细的内容，后面介绍）。

除了这三个图层外，还有一些元素需要参与绘制，比如：拖动改变元素大小的滑块、截图区域的遮罩等。这些元素是在窗口绘制事件中直接绘制到窗口上的。

## 图层合并

当用户在绘图层绘制完图像元素后（释放鼠标左键），会判断当前绘制的元素是否需要改变位置和大小（矩形、椭圆、箭头、文字），如果需要，则显示相关的滑块，供用户改变位置和大小，这个过程都是在绘图层完成的）。 `当用户点击右键，或开始绘制一个新元素时，绘图层的内容会被转移到背景层。` 橡皮擦和马赛克的图层合并工作比较特殊，后面再介绍。

# 橡皮擦

绘制橡皮擦元素，需要完成以下几步工作：

1. 把背景层内容（包含之前绘制的所有内容），转移到绘图层。
1. 在背景层绘制屏幕快照
1. 使用 `CompositionMode_Clear` 模式在绘图层绘制用户用鼠标拖拽出的路径
1. 绘制完成后，再把绘图层内容转移到背景层，同时清空绘图层内容
1. 拷贝背景图层橡皮擦绘制的路径区域（矩形）到绘图元素的`patchImg`属性中，用于undo redo（性能优化）。

# 马赛克

绘制马赛克元素，需要完成以下几步工作：

1. 当用户在绘图工具栏切换到马赛克模式后，基于当前背景层绘制一个马赛克层，(绘制的内容已被马赛克化后文有马赛克算法)。
1. 使用 `CompositionMode_Clear` 模式在背景层绘制用户用鼠标拖拽出的路径。
1. 绘制完成后：
    1. 把马赛克图层拷贝到绘图层
    1. 使用 `CompositionMode_SourceOver` 模式，把背景图层的内容绘制到绘图层
    1. 把绘图层内容拷贝到背景层
1. 拷贝背景图层马赛克绘制的路径区域（矩形）到绘图元素的`patchImg`属性中，用于undo redo（性能优化）。

马赛克算法：

1. 把一个图像按长与宽切割成N个小方格
1. 为每个小方格采样5个颜色值（左上角，右上角，左下角，右下角，中心点）
1. 取五个颜色值的平均值，创建一个新颜色
1. 用新颜色填充小方格

# 文字



# undo 与 redo

1. 点击`上一步`，把历史记录中最后一个`参与绘制`属性不为false的元素设置为false
1. 点击`下一步`，把历史记录中第一个`参与绘制`属性为false的元素设置为true
1. 在背景图层重绘所有`参与绘制`为true的元素
    - 如果绘制元素是`橡皮擦`或`马赛克`，则只需要把元素中的`patchImg`绘制出来即可，不用再完成图层合并等工作


# 跨屏截图

# 集成说明

大部分截图及绘制逻辑均在`MainWindow`窗口内实现，少量逻辑被抽象成了独立的类，比如：色彩选择器：`ColorSelector`、字体图标工具类：`Icon`、元素类：`PathModel`和线条控制器：`ButtonDot`等、文本输入类：`TextInputBox`。

集成时，这些类拷贝到目标项目中，在用户开始截图时，创建一个`MainWindow`窗口对象（不用Show，`MainWindow`类会在完成初始化工作后，自己Show出来）即可。